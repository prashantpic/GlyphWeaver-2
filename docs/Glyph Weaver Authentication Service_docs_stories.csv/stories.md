story_id,epic,title,user_role,description,priority,story_points,dependencies,acceptance_criteria_1,acceptance_criteria_2,acceptance_criteria_3,technical_tasks,definition_of_done
"US-101","Project Scaffolding and Core Configuration","Set Up Project Foundation and Configuration","Developer","As a Developer, I want a fully configured project structure with all dependencies, TypeScript settings, and environment variable management in place, so that I can start building features in a consistent and secure environment.","Must Have","3","","Given the project has been cloned, When I run `npm install` and then `npm run build`, Then all dependencies are installed without error and the TypeScript code compiles successfully into the `./dist` directory.","Given a valid `.env` file is present, When the application starts, Then the configuration module correctly loads and provides all required variables like `PORT` and `MONGODB_URI` in their correct types.","Given a required environment variable (e.g., `JWT_SECRET`) is missing from the environment, When the application starts, Then it throws a clear error and exits, preventing it from running in an insecure state.","WI-101, WI-102, WI-103","Code for project setup (`package.json`, `tsconfig.json`) and the config module is committed and peer-reviewed. All dependencies are defined. The application can be built and started locally using the new configuration."
"US-102","Project Scaffolding and Core Configuration","Establish Application Entrypoint and Server","Developer","As a Developer, I want the application to have a main entry point that correctly initializes the Express server, connects to the database, and starts listening for requests, so that the service can be run and tested.","Must Have","3","US-101, US-202, US-401, US-502","Given the application has been built and a valid `.env` file is present, When I run `npm start`, Then the application connects to the MongoDB instance and the server starts listening on the configured PORT without errors.","Given the server is running, When a request is made to a non-existent endpoint, Then the server returns a standard 404 Not Found response handled by the global error handler.","Given the Express app is configured, When a request is processed, Then core middleware for CORS and JSON body parsing is correctly applied before it reaches the router.","WI-104, WI-105","Code for `index.ts` and `app.ts` is implemented, reviewed, and merged. The application successfully bootstraps, connects to the database, and starts the server. Global error handling is registered."
"US-201","Domain and Persistence Layer","Define Core Data Models","Backend Developer","As a Backend Developer, I want to define the Mongoose data models for Users and Refresh Tokens, so that the application has a clear, validated schema for storing identity and session data in MongoDB.","Must Have","3","US-101","Given the User model definition, When a new user document is created, Then the `passwordHash` field is not returned in default queries and timestamps (`createdAt`, `updatedAt`) are automatically added.","Given the Token model definition, When a new token document is created with an `expiresAt` date in the past, Then MongoDB's TTL index automatically deletes the document after a short period.","Given the User model definition, When I attempt to create two users with the same email, Then the database layer throws a unique constraint violation error.","WI-201, WI-202","Mongoose schemas for User and Token are created as per the SDS. All fields, types, options, and indexes (including TTL) are correctly implemented and peer-reviewed."
"US-202","Domain and Persistence Layer","Implement Data Access Repositories","Backend Developer","As a Backend Developer, I want to implement the Repository Pattern for User and Token data, so that the application's business logic is decoupled from the MongoDB implementation, improving testability and maintainability.","Must Have","5","US-201","Given the `IUserRepository` interface and its `MongoUserRepository` implementation, When the `findByEmail` method is called, Then it correctly queries the database for a user and includes the `passwordHash` field for authentication purposes.","Given the `ITokenRepository` interface and its implementation, When the `save` and `findByToken` methods are used, Then a refresh token can be successfully saved to and retrieved from the database.","Given a repository method is called, When no document is found, Then the method returns `null` without throwing an error, allowing the service layer to handle the 'not found' case.","WI-203, WI-204, WI-205, WI-206","Interfaces for repositories are defined. Concrete `MongoUserRepository` and `MongoTokenRepository` classes are implemented and peer-reviewed. A `db.connection.ts` module is created to manage the Mongoose connection."
"US-301","Core Authentication Logic (Application Layer)","Implement Secure Password and Token Services","Backend Developer","As a Backend Developer, I want to create dedicated services for password hashing and JWT management, so that security-critical operations are centralized, consistently applied, and easily testable.","Must Have","5","US-101, US-202","Given a plain-text password, When I call `passwordService.hashPassword`, Then it returns a valid bcrypt hash string.","Given a plain-text password and a valid hash from the `hashPassword` method, When I call `passwordService.comparePassword`, Then it returns `true`.","Given a user ID payload, When `tokenService.generateAuthTokens` is called, Then it returns a valid access and refresh token pair, and the new refresh token is persisted to the database via the token repository.","WI-301, WI-302","`PasswordService` with bcrypt hashing/comparison and `TokenService` with JWT generation/verification and refresh token rotation logic are implemented, unit tested, and peer-reviewed."
"US-302","Core Authentication Logic (Application Layer)","Implement Email-Based Registration and Login","Client Application Developer","As a Client Application Developer, I want to be able to register a new user with an email and password and log in with those credentials, so that players can create and access their accounts.","Must Have","8","US-202, US-301, US-402, US-501","Given a unique email and a valid password, When a POST request is made to `/api/v1/auth/register`, Then a new user is created in the database, and a 201 response containing user info and auth tokens is returned.","Given an existing user's email and correct password, When a POST request is made to `/api/v1/auth/login/email`, Then a 200 response containing a new access and refresh token is returned.","Given an email that already exists in the system, When a POST request is made to `/api/v1/auth/register` with that email, Then the server returns a 409 Conflict error with a descriptive message.","WI-303 (email parts)","The `registerUser` and `authenticateByEmail` methods in `AuthService` are fully implemented, coordinating with repositories and other services. All logic paths are covered by unit tests."
"US-303","Core Authentication Logic (Application Layer)","Implement Platform-Based Login (Google/Apple)","Client Application Developer","As a Client Application Developer, I want to authenticate a user via a Google or Apple ID token, so that players can use convenient, platform-native sign-in options.","Must Have","8","US-202, US-301, US-402, US-501, US-503","Given a valid ID token from Google for a new user, When a POST request is made to `/api/v1/auth/login/platform`, Then a new user account is created with the Google identity, and a 200 response with auth tokens is returned.","Given a valid ID token from Apple for an existing user, When a POST request is made to `/api/v1/auth/login/platform`, Then the system finds the existing user, and a 200 response with auth tokens is returned.","Given an invalid or expired platform ID token, When a POST request is made to `/api/v1/auth/login/platform`, Then the server returns a 401 Unauthorized error.","WI-303 (platform parts)","The `authenticateByPlatformToken` method in `AuthService` is fully implemented, using the PlatformTokenValidator. Logic for finding, creating, and linking users is complete and unit tested."
"US-304","Core Authentication Logic (Application Layer)","Implement Token Refresh Flow","Client Application Developer","As a Client Application Developer, I want to exchange a valid refresh token for a new set of access and refresh tokens, so that the user can maintain their session without needing to log in again.","Must Have","5","US-301, US-402","Given a valid, unexpired refresh token, When a POST request is made to `/api/v1/auth/token/refresh`, Then the old token is invalidated, and a 200 response with a new access token and a new refresh token is returned.","Given an invalid, expired, or already used refresh token, When a POST request is made to `/api/v1/auth/token/refresh`, Then the server returns a 401 Unauthorized error.","Given a valid refresh token, When it is used to get new tokens, Then the original refresh token can no longer be used again to get more tokens (token rotation).","WI-303 (refresh part)","The `refreshAuthTokens` method in `AuthService` is fully implemented and unit tested, correctly using the `TokenService` to verify the old token and generate a new pair."
"US-401","API Layer (Presentation)","Define API Endpoints and DTOs","Backend Developer","As a Backend Developer, I want to define all API routes and their corresponding request body structures (DTOs) with validation, so that there is a clear and type-safe contract for clients to interact with the service.","Must Have","3","","Given the auth router, When a POST request is made to `/api/v1/auth/register`, `/api/v1/auth/login/email`, `/api/v1/auth/login/platform`, or `/api/v1/auth/token/refresh`, Then the request is directed to the appropriate controller method.","Given a request to `/api/v1/auth/register` with a body that has an invalid email format, When the request is processed, Then the validation middleware rejects it with a 400 Bad Request response before it reaches the service logic.","Given the DTO definitions, When a developer inspects the code, Then they can clearly see the expected properties and validation rules for each endpoint's request body.","WI-401, WI-403","All DTO files are created in `src/api/v1/dtos` with `class-validator` decorators. The `auth.routes.ts` file is created, defining all four POST endpoints as specified in the SDS."
"US-402","API Layer (Presentation)","Implement API Controller","Backend Developer","As a Backend Developer, I want to implement the `AuthController` to handle HTTP requests, delegate business logic to the `AuthService`, and format responses, so that the API endpoints are fully functional.","Must Have","3","US-302, US-303, US-304","Given a valid request to the `/register` endpoint, When the controller's `register` method is invoked, Then it calls `authService.registerUser`, and on success, sends a 201 response with the correct JSON payload.","Given a request that causes the `AuthService` to throw an `UnauthorizedException`, When the controller catches the error, Then it passes the error to the `next` function for the global error handler to process.","Given any of the four controller methods, When they are executed, Then they correctly extract the DTO from the request body and pass it to the appropriate service method.","WI-402","The `AuthController` class is implemented with methods for all four auth endpoints. Each method correctly orchestrates the call to the `AuthService` and handles the response or error."
"US-501","Security and Cross-Cutting Concerns","Implement Structured Logging","DevOps Engineer","As a DevOps Engineer, I want the application to produce structured (JSON), leveled logs, so that I can effectively monitor, debug, and audit the service in production using log aggregation tools.","Must Have","2","US-101","Given the `NODE_ENV` is set to 'production', When the application logs an event, Then the output is a single line of JSON containing a timestamp, log level, and message.","Given the `NODE_ENV` is set to 'development', When the application logs an event, Then the output is a human-readable, colorized message in the console.","Given the logger is configured, When it is imported into any service or controller, Then it can be used to log messages at different levels (info, warn, error).","WI-501","A `logger.ts` module is created using Winston. It correctly configures transports and formats based on the `NODE_ENV` and is injectable into other parts of the application."
"US-502","Security and Cross-Cutting Concerns","Implement Global Error Handling","Developer","As a Developer, I want a global error handling middleware, so that all application errors are caught and transformed into a consistent, user-friendly JSON response, while preventing sensitive information like stack traces from leaking in production.","Must Have","3","US-501","Given an error is passed to the `next()` function in any controller, When the request is processed, Then the global error handler middleware catches it and sends a formatted JSON error response.","Given the `NODE_ENV` is 'production' and an unhandled error occurs, When the error response is generated, Then it does not contain a `stack` trace property.","Given the `NODE_ENV` is 'development' and an unhandled error occurs, When the error is caught, Then the full error, including the stack trace, is logged to the console.","WI-503","An `error.handler.ts` middleware is implemented and registered as the last middleware in `app.ts`. It handles various error types and formats responses according to the SDS."
"US-503","Security and Cross-Cutting Concerns","Implement External Platform Token Validator","Backend Developer","As a Backend Developer, I want a dedicated service to validate identity tokens from Google and Apple, so that the complexity of interacting with external provider libraries is abstracted away from the main `AuthService`.","Must Have","5","US-101","Given a valid Google ID token, When I call `platformTokenValidator.validate('google', token)`, Then it returns a promise that resolves with the user's Google ID and email.","Given an invalid Apple identity token, When I call `platformTokenValidator.validate('apple', token)`, Then it returns a promise that rejects with an `UnauthorizedException`.","Given the validator service, When its dependencies (`google-auth-library`, `node-apple-signin-auth`) are updated, Then changes are isolated to this service and do not directly affect `AuthService`.","WI-504","An `IPlatformTokenValidator` interface and its concrete implementation `PlatformTokenValidator` are created. The `validate` method correctly uses the respective SDKs for Google and Apple token verification and is peer-reviewed."
"US-601","Quality and Operations","Set Up and Configure Test Framework","Developer","As a Developer, I want the project to be configured with the Jest testing framework, so that I can write and run unit and integration tests to ensure code quality and prevent regressions.","Should Have","2","US-101","Given the project is set up, When I run the `npm test` command, Then Jest executes all files ending in `.spec.ts` and shows a test summary.","Given the Jest configuration, When tests are run, Then code coverage reports are generated in a `coverage/` directory.","Given a simple test file is created, When `npm test` is run, Then the test passes successfully, confirming the setup is correct.","WI-601","A `jest.config.js` file is created and configured for the TypeScript project using `ts-jest`. The `test` script in `package.json` is updated to run Jest."
"US-602","Quality and Operations","Write Unit Tests for Core Services","Developer","As a Developer, I want to write comprehensive unit tests for all application services (`AuthService`, `TokenService`, `PasswordService`), so that I can verify the correctness of the business logic in isolation and with confidence.","Should Have","8","US-301, US-302, US-303, US-304, US-601","Given the `AuthService` unit tests, When the 'register user with existing email' scenario is run, Then the test asserts that a `ConflictException` is thrown, with all repository dependencies mocked.","Given the `TokenService` unit tests, When the 'verify a used refresh token' scenario is run, Then the test asserts that an `UnauthorizedException` is thrown because the mocked repository returns null.","Given the service unit tests, When `npm test -- --coverage` is run, Then the code coverage for the service files is above a predefined threshold (e.g., 80%).","WI-602","Unit test files (`*.spec.ts`) are created for all services in the `src/application/services` directory. Tests cover both success and failure paths, and all external dependencies are mocked."
"US-603","Quality and Operations","Write Integration Tests for API Endpoints","Developer","As a Developer, I want to write integration tests for all API endpoints, so that I can verify that the different layers of the application (controller, service, repository) work together correctly.","Should Have","8","US-402, US-601","Given the `/login/email` integration test, When a request is made with invalid credentials, Then the test asserts that the API returns a 401 status code and the response body has the correct error structure.","Given the `/register` integration test, When a request is made with a valid payload, Then the test asserts that the API returns a 201 status code, the response body contains tokens, and a new user record exists in the test database.","Given the API integration tests, When the test suite runs, Then it cleans and seeds the test database before and after tests to ensure test isolation.","WI-603","Integration test files are created for the `AuthController`. Tests use `supertest` to make HTTP requests to the application and validate responses against a live test database."
"US-604","Quality and Operations","Containerize the Application and Set Up CI","DevOps Engineer","As a DevOps Engineer, I want a `Dockerfile` to containerize the application and a basic CI pipeline, so that we can automate the process of building, testing, and packaging the service for consistent deployments.","Should Have","5","US-601, US-603","Given the `Dockerfile`, When I run `docker build`, Then it creates a production-ready container image using a multi-stage build to keep the size minimal.","Given a running container from the built image, When I send a request to a health check endpoint, Then it responds with a 200 OK status, confirming the application started correctly.","Given the CI pipeline configuration (e.g., GitHub Actions), When code is pushed to the `main` branch, Then the pipeline automatically triggers, runs the linter and all tests, and builds the Docker image, failing the build if any step fails.","WI-604, WI-605","A multi-stage `Dockerfile` and a `.dockerignore` file are created and peer-reviewed. A CI workflow file (e.g., `.github/workflows/ci.yml`) is created to automate testing and building on push."